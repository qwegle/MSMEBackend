const ACKForm = require('../models/acknowledgement');
const OTSForm = require('../models/otsform'); 

exports.createAckForm = async (req, res) => {
  try {
    // Create and save the acknowledgement form
    const form = new ACKForm(req.body);
    await form.save();

    // Extract the ots_form_id from the request body
    const { ots_form_id } = req.body;
    
    // Update the corresponding OTS form's status_msg
    if (ots_form_id) {
      await OTSForm.findByIdAndUpdate(
        ots_form_id,
        { status_msg: "Acknowledgement generated by branch office" },
        { new: true }
      );
    } else {
      console.warn('No ots_form_id provided in request body.');
    }

    res.status(201).json({ message: 'Form created successfully', form });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
};

exports.getAllAckForms = async (req, res) => {
  try {
    const forms = await ACKForm.find().populate('ots_form_id').sort({ createdAt: -1 });
    res.status(200).json(forms);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

exports.getAckFormsByUserId = async (req, res) => {
  try {
    const { userId } = req.params;

    if (!userId) {
      return res.status(400).json({ message: 'User ID is required' });
    }

    const forms = await ACKForm.find({ userId }).populate('ots_form_id').sort({ createdAt: -1 });

    if (!forms.length) {
      return res.status(404).json({ message: 'No acknowledgements found for this user.' });
    }

    res.status(200).json(forms);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

exports.filterAckForms = async (req, res) => {
  const { userId, loan_number, branch } = req.body;

  try {
    const pipeline = [
      {
        $lookup: {
          from: 'otsforms',
          localField: 'ots_form_id',
          foreignField: '_id',
          as: 'otsDetails'
        }
      },
      { $unwind: '$otsDetails' },
    ];

    const matchConditions = {};

    if (userId) {
      matchConditions['otsDetails.userId'] = userId;
    }
    if (loan_number) {
      matchConditions['otsDetails.loan_number'] = loan_number;
    }
    if (branch) {
      matchConditions['otsDetails.branch'] = branch;
    }

    if (Object.keys(matchConditions).length > 0) {
      pipeline.push({ $match: matchConditions });
    }

    // Add projection stage to return only required fields
    pipeline.push({
      $project: {
        _id: 0,
        first_name: '$otsDetails.first_name',
        last_name: '$otsDetails.last_name',
        loan_number: '$otsDetails.loan_number',
        img_link_sign_stamp: 1
      }
    });

    const forms = await ACKForm.aggregate(pipeline).sort({ createdAt: -1 });

    res.status(200).json({
      message: Object.keys(matchConditions).length > 0
        ? 'Filtered acknowledgement forms retrieved successfully'
        : 'All acknowledgement forms retrieved successfully',
      data: forms
    });

  } catch (error) {
    console.error('Error filtering acknowledgement forms:', error);
    res.status(500).json({ message: 'Server error', error: error.message });
  }
};



// // Get all forms
// exports.getAllForms = async (req, res) => {
//   try {
//     const forms = await Form.find().populate('ots_form_id');
//     res.status(200).json(forms);
//   } catch (error) {
//     res.status(500).json({ error: error.message });
//   }
// };

// // Get a form by ID
// exports.getFormById = async (req, res) => {
//   try {
//     const form = await Form.findById(req.params.id).populate('ots_form_id');
//     if (!form) {
//       return res.status(404).json({ message: 'Form not found' });
//     }
//     res.status(200).json(form);
//   } catch (error) {
//     res.status(500).json({ error: error.message });
//   }
// };

// // Update a form by ID
// exports.updateForm = async (req, res) => {
//   try {
//     const updatedForm = await Form.findByIdAndUpdate(req.params.id, req.body, {
//       new: true,
//       runValidators: true
//     });
//     if (!updatedForm) {
//       return res.status(404).json({ message: 'Form not found' });
//     }
//     res.status(200).json({ message: 'Form updated successfully', form: updatedForm });
//   } catch (error) {
//     res.status(400).json({ error: error.message });
//   }
// };

// // Delete a form by ID
// exports.deleteForm = async (req, res) => {
//   try {
//     const deletedForm = await Form.findByIdAndDelete(req.params.id);
//     if (!deletedForm) {
//       return res.status(404).json({ message: 'Form not found' });
//     }
//     res.status(200).json({ message: 'Form deleted successfully' });
//   } catch (error) {
//     res.status(500).json({ error: error.message });
//   }
// };
