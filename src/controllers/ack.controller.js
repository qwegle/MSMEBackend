const ACKForm = require('../models/acknowledgement');
const OTSForm = require('../models/otsform'); 
require('dotenv').config();
exports.createAckForm = async (req, res) => {
  try {
    const filePath = req.file ?  `${process.env.NODE_APP_URL}/uploads/${req.file.filename}` : null;

    if (!filePath) {
      return res.status(400).json({ error: 'Image is required' });
    }
    const form = new ACKForm({
      ...req.body,
      img_link_sign_stamp: filePath
    });
    await form.save();
    const { loan_number } = req.body;
    if (loan_number) {
      await OTSForm.findOneAndUpdate(
        { loan_number: loan_number }, // Match by unique field
        { status_msg: "Acknowledgement generated by branch office" },
        { new: true }
      );
    }

    res.status(201).json({ message: 'Form created successfully', form });
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
};

exports.getAllAckForms = async (req, res) => {
  try {
    const forms = await ACKForm.find().populate('ots_form_id').sort({ createdAt: -1 });
    res.status(200).json(forms);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

exports.getAckFormsByUserId = async (req, res) => {
  try {
    const { userId } = req.params;

    if (!userId) {
      return res.status(400).json({ message: 'User ID is required' });
    }

    const forms = await ACKForm.find({ userId }).populate('ots_form_id').sort({ createdAt: -1 });

    if (!forms.length) {
      return res.status(404).json({ message: 'No acknowledgements found for this user.' });
    }

    res.status(200).json(forms);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
};

exports.filterAckForms = async (req, res) => {
  const { userId, loan_number, branch } = req.body;

  try {
    const pipeline = [
      {
        $lookup: {
          from: 'otsforms',
          localField: 'ots_form_id',
          foreignField: '_id',
          as: 'otsDetails'
        }
      },
      { $unwind: '$otsDetails' },
    ];

    const matchConditions = {};

    if (userId) {
      matchConditions['otsDetails.userId'] = userId;
    }
    if (loan_number) {
      matchConditions['otsDetails.loan_number'] = loan_number;
    }
    if (branch) {
      matchConditions['otsDetails.branch'] = branch;
    }

    if (Object.keys(matchConditions).length > 0) {
      pipeline.push({ $match: matchConditions });
    }
    pipeline.push({
      $project: {
        _id: 0,
        first_name: '$otsDetails.first_name',
        last_name: '$otsDetails.last_name',
        loan_number: '$otsDetails.loan_number',
        img_link_sign_stamp: 1
      }
    });

    const forms = await ACKForm.aggregate(pipeline).sort({ createdAt: -1 });

    res.status(200).json(
      // message: Object.keys(matchConditions).length > 0
      //   ? 'Filtered acknowledgement forms retrieved successfully'
      //   : 'All acknowledgement forms retrieved successfully',
      forms
    );

  } catch (error) {
    console.error('Error filtering acknowledgement forms:', error);
    res.status(500).json({ message: 'Server error', error: error.message });
  }
};

exports.getCertificateCountsLast7Days = async (req, res) => {
  try {
    const timezone = 'Asia/Kolkata';
    const end   = new Date();     
    end.setHours(23, 59, 59, 999);
    const start = new Date(end);
    start.setDate(end.getDate() - 6);
    start.setHours(0, 0, 0, 0);
    const raw = await CertificateOrder.aggregate([
      { $match: { createdAt: { $gte: start, $lte: end } } },
      {
        $group: {
          _id: {
            $dateToString: {
              format: '%d/%m/%Y',
              date: '$createdAt',
              timezone  
            }
          },
          count: { $sum: 1 }
        }
      },
      { $project: { _id: 0, date: '$_id', count: 1 } }
    ]);
    const lookup = Object.fromEntries(raw.map(o => [o.date, o.count]));
    const response = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date(end);
      d.setDate(end.getDate() - i);
      const dateStr = d
        .toLocaleDateString('en-GB', { timeZone: timezone })
        .split('/')
        .map(s => s.padStart(2, '0'))
        .join('/');
      response.push({
        date: dateStr,
        count: lookup[dateStr] ?? 0
      });
    }

    return res.status(200).json(response);
  } catch (err) {
    console.error('Error getting 7-day certificate counts:', err);
    return res.status(500).json({ message: 'Server error', error: err.message });
  }
};




// // Get all forms
// exports.getAllForms = async (req, res) => {
//   try {
//     const forms = await Form.find().populate('ots_form_id');
//     res.status(200).json(forms);
//   } catch (error) {
//     res.status(500).json({ error: error.message });
//   }
// };

// // Get a form by ID
// exports.getFormById = async (req, res) => {
//   try {
//     const form = await Form.findById(req.params.id).populate('ots_form_id');
//     if (!form) {
//       return res.status(404).json({ message: 'Form not found' });
//     }
//     res.status(200).json(form);
//   } catch (error) {
//     res.status(500).json({ error: error.message });
//   }
// };

// // Update a form by ID
// exports.updateForm = async (req, res) => {
//   try {
//     const updatedForm = await Form.findByIdAndUpdate(req.params.id, req.body, {
//       new: true,
//       runValidators: true
//     });
//     if (!updatedForm) {
//       return res.status(404).json({ message: 'Form not found' });
//     }
//     res.status(200).json({ message: 'Form updated successfully', form: updatedForm });
//   } catch (error) {
//     res.status(400).json({ error: error.message });
//   }
// };

// // Delete a form by ID
// exports.deleteForm = async (req, res) => {
//   try {
//     const deletedForm = await Form.findByIdAndDelete(req.params.id);
//     if (!deletedForm) {
//       return res.status(404).json({ message: 'Form not found' });
//     }
//     res.status(200).json({ message: 'Form deleted successfully' });
//   } catch (error) {
//     res.status(500).json({ error: error.message });
//   }
// };
