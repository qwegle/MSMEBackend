const Memorandum = require('../models/memorandum');
const OTSForm = require('../models/otsform');
const AckForm = require('../models/acknowledgement');
const User = require('../models/user');

const uploadPdf = async (req, res) => {
  try {
    const filePath = req.file ? `${process.env.NODE_APP_URL}/uploads/${req.file.filename}` : null;
    if (!filePath) {
      return res.status(400).json({ error: 'PDF file is required' });
    }
    const { loan_number } = req.body;
    if (!loan_number) {
      return res.status(400).json({ error: 'loan_number is required' });
    }
    const otsForm = await OTSForm.findOne({ loan_number });
    if (!otsForm) {
      return res.status(404).json({ error: 'OTSForm not found for given loan_number' });
    }
    const userId = otsForm.userId;
    const otsFormId = otsForm._id;
    const ackForm = await AckForm.findOne({ ots_form_id: otsFormId });
    if (!ackForm) {
      return res.status(404).json({ error: 'Acknowledgement form not found for this OTSForm' });
    }
    const ackId = ackForm._id;
    const newMemo = new Memorandum({
      userId,
      otsFormId,
      ackId,
      pdfData: filePath,
    });
    await newMemo.save();
    await OTSForm.findByIdAndUpdate(
      otsFormId,
      { status_msg: 'Memorandum generated by branch office' },
      { new: true }
    );
    res.status(201).json({
      message: 'PDF uploaded and memorandum saved successfully',
      id: newMemo._id,
    });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: 'Internal Server Error' });
  }
};
// super admin api
const updateMemoStatus = async (req, res) => {
  try {
    const { memoId, status, remarks } = req.body;

    const updatedMemo = await Memorandum.findByIdAndUpdate(
      memoId,
      { status, remarks },
      { new: true }
    );

    if (!updatedMemo) {
      return res.status(404).json({ message: 'Memorandum not found' });
    }
    if (status === 2) {
      await OTSForm.findByIdAndUpdate(
        updatedMemo.otsFormId,
        { status_msg: "application is rejected by head office" }
      );
    } else if (status === 0) {
      await OTSForm.findByIdAndUpdate(
        updatedMemo.otsFormId,
        { status_msg: "Application is being processed by admin office" }
      );
    } else {
        await OTSForm.findByIdAndUpdate(
        updatedMemo.otsFormId,
        { status_msg: "Application has been approved.." }
      );
    }

    res.json({ message: 'Memo status updated successfully', memo: updatedMemo });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};
const reuploadMemo = async (req, res) => {
  try {
    const { userId, otsFormId, ackId } = req.body;

    if (!req.file) {
      return res.status(400).json({ error: 'No PDF file uploaded' });
    }
    const lastMemo = await Memorandum.findOne({ otsFormId }).sort({ memoVersion: -1 });
    const newMemo = new Memorandum({
      userId,
      otsFormId,
      ackId,
      status: 1,
      remarks: "Resubmitted after rejection",
      memoVersion: lastMemo ? lastMemo.memoVersion + 1 : 1,
      pdfData: {
        data: req.file.buffer,
        contentType: req.file.mimetype,
      },
    });

    await newMemo.save();
    await OTSForm.findByIdAndUpdate(
      otsFormId,
      { status_msg: "memorandum regenerated by branch office" }
    );

    res.status(201).json({ message: 'Memorandum reuploaded successfully', memoId: newMemo._id });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

const getMemosByUserId = async (req, res) => {
  try {
    const { userId } = req.params;

    if (!userId) {
      return res.status(400).json({ error: 'User ID is required' });
    }

    const memos = await Memorandum.find({ userId }).sort({ createdAt: -1 });

    if (!memos.length) {
      return res.status(404).json({ message: 'No memorandums found for this user' });
    }

    res.json(memos);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// const getAllMemos = async (req, res) => {
//   try {
//     const memos = await Memorandum.find().sort({ createdAt: -1 });
//     res.json(memos);
//   } catch (err) {
//     res.status(500).json({ error: err.message });
//   }
// };
  const getAllMemos = async (req, res) => {
  try {
    const { loan_number, userId, branch, status } = req.body;

    let memoFilter = {};

    if (loan_number) {
      // Directly find the OTSForm by unique loan_number
      const otsForm = await OTSForm.findOne({ loan_number });

      if (!otsForm) {
        return res.status(404).json({ error: 'No OTS Form found for the given loan number' });
      }

      memoFilter.otsFormId = otsForm._id;
    } else {
      // Build user filter if loan_number is not present
      const userFilter = {};
      if (userId) userFilter._id = userId;
      if (branch) userFilter.branch = branch;
      if (status) memoFilter.status = status;
      let matchedUserIds = [];
      if (Object.keys(userFilter).length > 0) {
        const users = await User.find(userFilter).select('_id');
        matchedUserIds = users.map(user => user._id);
      }

      const otsFilter = {};
      if (matchedUserIds.length > 0) {
        otsFilter.userId = { $in: matchedUserIds };
      }

      const matchedOtsForms = await OTSForm.find(otsFilter).select('_id');
      const matchedOtsIds = matchedOtsForms.map(ots => ots._id);

      if (matchedOtsIds.length > 0) {
        memoFilter.otsFormId = { $in: matchedOtsIds };
      } else {
        // No matching OTSForms, return early
        return res.json([]);
      }
    }

    // Fetch and populate
    const memos = await Memorandum.find(memoFilter)
      .sort({ createdAt: -1 })
      .populate('userId', 'username email user_type user_role branch aadharNumber')
      .populate('otsFormId')
      .populate('ackId');

    res.json(memos);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};



// // Get PDF by ID (view or download)
// const getPdfById = async (req, res) => {
//   try {
//     const { id } = req.params;
//     const pdfDoc = await Memorandum.findById(id);

//     if (!pdfDoc || !pdfDoc.pdfData?.data) {
//       return res.status(404).json({ error: 'PDF not found' });
//     }

//     res.set({
//       'Content-Type': pdfDoc.pdfData.contentType || 'application/pdf',
//       'Content-Disposition': 'inline; filename="document.pdf"', // use "attachment" for download
//     });

//     res.send(pdfDoc.pdfData.data);
//   } catch (err) {
//     res.status(500).json({ error: err.message });
//   }
// };

// // Optional: List all PDFs
// const listAllPdfs = async (req, res) => {
//   try {
//     const pdfs = await Memorandum.find().select('-pdfData'); // exclude binary data for listing
//     res.json(pdfs);
//   } catch (err) {
//     res.status(500).json({ error: err.message });
//   }
// };

module.exports = {
  uploadPdf,
  updateMemoStatus,
  reuploadMemo,
  getMemosByUserId,
  getAllMemos
//   getPdfById,
//   listAllPdfs,
};
