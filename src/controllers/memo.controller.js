const Memorandum = require('../models/memorandum');
const OTSForm = require('../models/otsform');
const AckForm = require('../models/acknowledgement');

const uploadPdf = async (req, res) => {
  try {
    const filePath = req.file ? `/uploads/${req.file.filename}` : null;

    if (!filePath) {
      return res.status(400).json({ error: 'PDF file is required' });
    }

    const { loan_number } = req.body;

    if (!loan_number) {
      return res.status(400).json({ error: 'loan_number is required' });
    }

    const otsForm = await OTSForm.findOne({ loan_number });

    if (!otsForm) {
      return res.status(404).json({ error: 'OTSForm not found for given loan_number' });
    }

    const userId = otsForm.userId;
    const otsFormId = otsForm._id;
    const ackForm = await AckForm.findOne({ ots_form_id: otsFormId });

    if (!ackForm) {
      return res.status(404).json({ error: 'Acknowledgement form not found for this OTSForm' });
    }
    const ackId = ackForm._id;
    const newMemo = new Memorandum({
      userId,
      otsFormId,
      ackId,
      pdf_link: filePath,
    });

    await newMemo.save();
    await OTSForm.findByIdAndUpdate(
      otsFormId,
      { status_msg: 'Memorandum generated by branch office' },
      { new: true }
    );

    res.status(201).json({
      message: 'PDF uploaded and memorandum saved successfully',
      id: newMemo._id,
    });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: 'Internal Server Error' });
  }
};

const updateMemoStatus = async (req, res) => {
  try {
    const { memoId, status, remarks } = req.body;

    const updatedMemo = await Memorandum.findByIdAndUpdate(
      memoId,
      { status, remarks },
      { new: true }
    );

    if (!updatedMemo) {
      return res.status(404).json({ message: 'Memorandum not found' });
    }
    if (status === 0) {
      await OTSForm.findByIdAndUpdate(
        updatedMemo.otsFormId,
        { status_msg: "application is rejected by head office" }
      );
    } else if (status === 1) {
      await OTSForm.findByIdAndUpdate(
        updatedMemo.otsFormId,
        { status_msg: "Application is being processed by admin office" }
      );
    }

    res.json({ message: 'Memo status updated successfully', memo: updatedMemo });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};
const reuploadMemo = async (req, res) => {
  try {
    const { userId, otsFormId, ackId } = req.body;

    if (!req.file) {
      return res.status(400).json({ error: 'No PDF file uploaded' });
    }
    const lastMemo = await Memorandum.findOne({ otsFormId }).sort({ memoVersion: -1 });
    const newMemo = new Memorandum({
      userId,
      otsFormId,
      ackId,
      status: 1,
      remarks: "Resubmitted after rejection",
      memoVersion: lastMemo ? lastMemo.memoVersion + 1 : 1,
      pdfData: {
        data: req.file.buffer,
        contentType: req.file.mimetype,
      },
    });

    await newMemo.save();
    await OTSForm.findByIdAndUpdate(
      otsFormId,
      { status_msg: "memorandum regenerated by branch office" }
    );

    res.status(201).json({ message: 'Memorandum reuploaded successfully', memoId: newMemo._id });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

const getMemosByUserId = async (req, res) => {
  try {
    const { userId } = req.params;

    if (!userId) {
      return res.status(400).json({ error: 'User ID is required' });
    }

    const memos = await Memorandum.find({ userId }).sort({ createdAt: -1 });

    if (!memos.length) {
      return res.status(404).json({ message: 'No memorandums found for this user' });
    }

    res.json(memos);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

const getAllMemos = async (req, res) => {
  try {
    const memos = await Memorandum.find().sort({ createdAt: -1 }); // newest first
    res.json(memos);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};


// // Get PDF by ID (view or download)
// const getPdfById = async (req, res) => {
//   try {
//     const { id } = req.params;
//     const pdfDoc = await Memorandum.findById(id);

//     if (!pdfDoc || !pdfDoc.pdfData?.data) {
//       return res.status(404).json({ error: 'PDF not found' });
//     }

//     res.set({
//       'Content-Type': pdfDoc.pdfData.contentType || 'application/pdf',
//       'Content-Disposition': 'inline; filename="document.pdf"', // use "attachment" for download
//     });

//     res.send(pdfDoc.pdfData.data);
//   } catch (err) {
//     res.status(500).json({ error: err.message });
//   }
// };

// // Optional: List all PDFs
// const listAllPdfs = async (req, res) => {
//   try {
//     const pdfs = await Memorandum.find().select('-pdfData'); // exclude binary data for listing
//     res.json(pdfs);
//   } catch (err) {
//     res.status(500).json({ error: err.message });
//   }
// };

module.exports = {
  uploadPdf,
  updateMemoStatus,
  reuploadMemo,
  getMemosByUserId,
  getAllMemos
//   getPdfById,
//   listAllPdfs,
};
